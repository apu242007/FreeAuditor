<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeAuditor - Herramienta de Auditor√≠a Gratuita</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .nav-tab:hover {
            background: #f5f5f5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .audit-results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .result-item.warning {
            border-left-color: #ffc107;
        }

        .result-item.error {
            border-left-color: #dc3545;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .hidden {
            display: none;
        }

        .modal.hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .template-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .template-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-controls {
            display: flex;
            gap: 10px;
        }

        .section-controls button {
            padding: 5px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .template-question {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .question-controls {
            display: flex;
            gap: 5px;
        }

        .question-controls button {
            padding: 2px 8px;
            font-size: 0.7rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç FreeAuditor</h1>
            <p>Herramienta de Auditor√≠a Gratuita - Analiza y mejora tu negocio</p>
        </div>

        <div class="main-content">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('audit')">Nueva Auditor√≠a</button>
                <button class="nav-tab" onclick="switchTab('templates')">Plantillas</button>
                <button class="nav-tab" onclick="switchTab('results')">Resultados</button>
                <button class="nav-tab" onclick="switchTab('reports')">Reportes</button>
                <button class="nav-tab" onclick="switchTab('settings')">Configuraci√≥n</button>
            </div>

            <!-- Nueva Auditor√≠a Tab -->
            <div id="audit" class="tab-content active">
                <h2>Crear Nueva Auditor√≠a</h2>
                <form id="auditForm">
                    <div class="form-group">
                        <label for="auditType">Tipo de Auditor√≠a:</label>
                        <select id="auditType" name="auditType">
                            <option value="financial">Auditor√≠a Financiera</option>
                            <option value="security">Auditor√≠a de Seguridad</option>
                            <option value="compliance">Auditor√≠a de Cumplimiento</option>
                            <option value="operational">Auditor√≠a Operacional</option>
                            <option value="it">Auditor√≠a de TI</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="companyName">Nombre de la Empresa:</label>
                        <input type="text" id="companyName" name="companyName" required>
                    </div>

                    <div class="form-group">
                        <label for="auditPeriod">Per√≠odo de Auditor√≠a:</label>
                        <input type="date" id="auditStartDate" name="auditStartDate" style="width: 48%; margin-right: 4%;" required>
                        <input type="date" id="auditEndDate" name="auditEndDate" style="width: 48%;" required>
                    </div>

                    <div class="form-group">
                        <label for="auditScope">Alcance de la Auditor√≠a:</label>
                        <textarea id="auditScope" name="auditScope" rows="4" placeholder="Describe el alcance y objetivos de la auditor√≠a..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="auditor">Auditor Responsable:</label>
                        <input type="text" id="auditor" name="auditor" required>
                    </div>

                    <button type="submit" class="btn">Iniciar Auditor√≠a</button>
                </form>

                <div id="auditProgress" class="hidden">
                    <h3>Progreso de la Auditor√≠a</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">Iniciando auditor√≠a...</p>
                </div>
            </div>

            <!-- Plantillas Tab -->
            <div id="templates" class="tab-content">
                <h2>Gesti√≥n de Plantillas</h2>
                <div class="template-controls" style="margin-bottom: 20px;">
                    <button class="btn" onclick="showTemplateBuilder()">+ Nueva Plantilla</button>
                    <button class="btn btn-secondary" onclick="importTemplate()">Importar Plantilla</button>
                </div>

                <div id="templatesList">
                    <div class="grid" id="templatesGrid">
                        <!-- Templates will be loaded here -->
                    </div>
                </div>

                <!-- Template Builder Modal -->
                <div id="templateBuilderModal" class="modal hidden">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="templateBuilderTitle">Nueva Plantilla</h3>
                            <button class="close-btn" onclick="closeTemplateBuilder()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="templateName">Nombre de la Plantilla:</label>
                                <input type="text" id="templateName" placeholder="Ej: Auditor√≠a de Seguridad Industrial">
                            </div>
                            <div class="form-group">
                                <label for="templateCategory">Categor√≠a:</label>
                                <select id="templateCategory">
                                    <option value="safety">Seguridad</option>
                                    <option value="quality">Calidad</option>
                                    <option value="environment">Medio Ambiente</option>
                                    <option value="compliance">Cumplimiento</option>
                                    <option value="operational">Operacional</option>
                                    <option value="financial">Financiera</option>
                                    <option value="it">Tecnolog√≠a</option>
                                    <option value="custom">Personalizada</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="templateDescription">Descripci√≥n:</label>
                                <textarea id="templateDescription" rows="3" placeholder="Describe el prop√≥sito y alcance de esta plantilla..."></textarea>
                            </div>

                            <h4>Secciones de la Plantilla</h4>
                            <div id="templateSections">
                                <!-- Sections will be added here -->
                            </div>
                            <button class="btn btn-secondary" onclick="addTemplateSection()">+ Agregar Secci√≥n</button>

                            <div class="modal-actions">
                                <button class="btn" onclick="saveTemplate()">Guardar Plantilla</button>
                                <button class="btn btn-secondary" onclick="closeTemplateBuilder()">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resultados Tab -->
            <div id="results" class="tab-content">
                <h2>Resultados de Auditor√≠as</h2>
                <div id="resultsContainer">
                    <p>No hay auditor√≠as completadas a√∫n.</p>
                </div>
            </div>

            <!-- Reportes Tab -->
            <div id="reports" class="tab-content">
                <h2>Generar Reportes</h2>
                <div class="grid">
                    <div class="card">
                        <h3>Reporte Ejecutivo</h3>
                        <p>Resumen de hallazgos principales y recomendaciones.</p>
                        <button class="btn" onclick="generateReport('executive')">Generar</button>
                    </div>
                    <div class="card">
                        <h3>Reporte Detallado</h3>
                        <p>An√°lisis completo con todos los hallazgos y evidencias.</p>
                        <button class="btn" onclick="generateReport('detailed')">Generar</button>
                    </div>
                    <div class="card">
                        <h3>Reporte de Cumplimiento</h3>
                        <p>Estado de cumplimiento de normativas y regulaciones.</p>
                        <button class="btn" onclick="generateReport('compliance')">Generar</button>
                    </div>
                </div>
            </div>

            <!-- Configuraci√≥n Tab -->
            <div id="settings" class="tab-content">
                <h2>Configuraci√≥n</h2>
                <div class="form-group">
                    <label for="language">Idioma:</label>
                    <select id="language">
                        <option value="es">Espa√±ol</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="defaultAuditor">Auditor por Defecto:</label>
                    <input type="text" id="defaultAuditor" placeholder="Nombre del auditor por defecto">
                </div>
                <div class="form-group">
                    <label for="companyInfo">Informaci√≥n de la Empresa:</label>
                    <textarea id="companyInfo" rows="3" placeholder="Informaci√≥n general de tu empresa..."></textarea>
                </div>
                <button class="btn" onclick="saveSettings()">Guardar Configuraci√≥n</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentAudits = JSON.parse(localStorage.getItem('audits') || '[]');
        let auditCounter = parseInt(localStorage.getItem('auditCounter') || '0');
        let templates = JSON.parse(localStorage.getItem('templates') || '[]');
        let templateCounter = parseInt(localStorage.getItem('templateCounter') || '0');
        let currentEditingTemplate = null;

        // Funciones de gesti√≥n de plantillas
        function loadTemplates() {
            const grid = document.getElementById('templatesGrid');
            
            if (templates.length === 0) {
                grid.innerHTML = '<p>No hay plantillas creadas a√∫n. <a href="#" onclick="showTemplateBuilder()">Crear primera plantilla</a></p>';
                return;
            }

            let html = '';
            templates.forEach(template => {
                html += `
                    <div class="card">
                        <h3>${template.name}</h3>
                        <p><strong>Categor√≠a:</strong> ${getCategoryName(template.category)}</p>
                        <p>${template.description}</p>
                        <p><strong>Secciones:</strong> ${template.sections ? template.sections.length : 0}</p>
                        <p><strong>Creada:</strong> ${new Date(template.createdAt).toLocaleDateString()}</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="useTemplate(${template.id})" style="margin-right: 10px;">
                                Usar Plantilla
                            </button>
                            <button class="btn btn-info" onclick="editTemplate(${template.id})" style="margin-right: 10px;">
                                Editar
                            </button>
                            <button class="btn btn-danger" onclick="deleteTemplate(${template.id})">
                                Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function getCategoryName(category) {
            const categories = {
                'safety': 'Seguridad',
                'quality': 'Calidad',
                'environment': 'Medio Ambiente',
                'compliance': 'Cumplimiento',
                'operational': 'Operacional',
                'financial': 'Financiera',
                'it': 'Tecnolog√≠a',
                'custom': 'Personalizada'
            };
            return categories[category] || category;
        }

        function showTemplateBuilder() {
            currentEditingTemplate = null;
            document.getElementById('templateBuilderTitle').textContent = 'Nueva Plantilla';
            document.getElementById('templateName').value = '';
            document.getElementById('templateCategory').value = 'safety';
            document.getElementById('templateDescription').value = '';
            document.getElementById('templateSections').innerHTML = '';
            document.getElementById('templateBuilderModal').classList.remove('hidden');
            
            // Add initial section
            addTemplateSection();
        }

        function editTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;

            currentEditingTemplate = template;
            document.getElementById('templateBuilderTitle').textContent = 'Editar Plantilla';
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateCategory').value = template.category;
            document.getElementById('templateDescription').value = template.description;
            
            // Load sections
            const sectionsContainer = document.getElementById('templateSections');
            sectionsContainer.innerHTML = '';
            
            if (template.sections) {
                template.sections.forEach(section => {
                    addTemplateSection(section);
                });
            }
            
            document.getElementById('templateBuilderModal').classList.remove('hidden');
        }

        function closeTemplateBuilder() {
            document.getElementById('templateBuilderModal').classList.add('hidden');
            currentEditingTemplate = null;
        }

        function addTemplateSection(sectionData = null) {
            const sectionsContainer = document.getElementById('templateSections');
            const sectionId = Date.now();
            
            const sectionHtml = `
                <div class="template-section" data-section-id="${sectionId}">
                    <div class="template-section-header">
                        <input type="text" placeholder="Nombre de la secci√≥n" class="section-name" value="${sectionData ? sectionData.name : ''}" style="font-weight: bold; font-size: 1.1rem;">
                        <div class="section-controls">
                            <button class="btn-info" onclick="addQuestion(${sectionId})">+ Pregunta</button>
                            <button class="btn-danger" onclick="removeSection(${sectionId})">Eliminar Secci√≥n</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Descripci√≥n de la secci√≥n:</label>
                        <textarea class="section-description" rows="2" placeholder="Describe qu√© eval√∫a esta secci√≥n...">${sectionData ? sectionData.description : ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" class="section-repeatable" ${sectionData && sectionData.repeatable ? 'checked' : ''}> 
                            Secci√≥n repetible (para elementos m√∫ltiples)
                        </label>
                    </div>
                    
                    <h5>Preguntas:</h5>
                    <div class="questions-container" data-section-id="${sectionId}">
                        <!-- Questions will be added here -->
                    </div>
                </div>
            `;
            
            sectionsContainer.insertAdjacentHTML('beforeend', sectionHtml);
            
            // Load questions if editing
            if (sectionData && sectionData.questions) {
                sectionData.questions.forEach(question => {
                    addQuestion(sectionId, question);
                });
            }
        }

        function removeSection(sectionId) {
            const section = document.querySelector(`[data-section-id="${sectionId}"]`);
            if (section && confirm('¬øEst√°s seguro de eliminar esta secci√≥n?')) {
                section.remove();
            }
        }

        function addQuestion(sectionId, questionData = null) {
            const questionsContainer = document.querySelector(`.questions-container[data-section-id="${sectionId}"]`);
            const questionId = Date.now() + Math.random();
            
            const questionHtml = `
                <div class="template-question" data-question-id="${questionId}">
                    <div class="question-header">
                        <input type="text" placeholder="Texto de la pregunta" class="question-text" value="${questionData ? questionData.text : ''}" style="width: 70%;">
                        <div class="question-controls">
                            <select class="question-type" onchange="updateQuestionType(${questionId})">
                                <option value="text" ${questionData && questionData.type === 'text' ? 'selected' : ''}>Texto</option>
                                <option value="number" ${questionData && questionData.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                                <option value="select" ${questionData && questionData.type === 'select' ? 'selected' : ''}>Selecci√≥n</option>
                                <option value="checkbox" ${questionData && questionData.type === 'checkbox' ? 'selected' : ''}>Casillas</option>
                                <option value="radio" ${questionData && questionData.type === 'radio' ? 'selected' : ''}>Opci√≥n √∫nica</option>
                                <option value="date" ${questionData && questionData.type === 'date' ? 'selected' : ''}>Fecha</option>
                                <option value="photo" ${questionData && questionData.type === 'photo' ? 'selected' : ''}>Foto</option>
                            </select>
                            <button class="btn-danger" onclick="removeQuestion(${questionId})">√ó</button>
                        </div>
                    </div>
                    
                    <div class="question-options">
                        <label>
                            <input type="checkbox" class="question-required" ${questionData && questionData.required ? 'checked' : ''}> 
                            Obligatoria
                        </label>
                        <label style="margin-left: 15px;">
                            <input type="checkbox" class="question-scored" onchange="toggleScoring(${questionId})" ${questionData && questionData.scored ? 'checked' : ''}> 
                            Puntuable
                        </label>
                    </div>
                    
                    <div class="question-config" data-question-id="${questionId}">
                        <!-- Configuration specific to question type will be added here -->
                    </div>
                </div>
            `;
            
            questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
            updateQuestionType(questionId);
            
            // Load question data if editing
            if (questionData) {
                setTimeout(() => {
                    if (questionData.options) {
                        const optionsContainer = document.querySelector(`[data-question-id="${questionId}"] .options-list`);
                        if (optionsContainer) {
                            optionsContainer.innerHTML = '';
                            questionData.options.forEach(option => {
                                addQuestionOption(questionId, option.text, option.score);
                            });
                        }
                    }
                    if (questionData.scoring) {
                        const maxScore = document.querySelector(`[data-question-id="${questionId}"] .max-score`);
                        if (maxScore) maxScore.value = questionData.scoring.maxScore || '';
                    }
                }, 100);
            }
        }

        function removeQuestion(questionId) {
            const question = document.querySelector(`[data-question-id="${questionId}"]`);
            if (question && confirm('¬øEliminar esta pregunta?')) {
                question.remove();
            }
        }

        function updateQuestionType(questionId) {
            const questionDiv = document.querySelector(`[data-question-id="${questionId}"]`);
            const type = questionDiv.querySelector('.question-type').value;
            const configDiv = questionDiv.querySelector('.question-config');
            
            let configHtml = '';
            
            if (type === 'select' || type === 'radio' || type === 'checkbox') {
                configHtml = `
                    <div class="form-group">
                        <label>Opciones:</label>
                        <div class="options-list" data-question-id="${questionId}">
                            <!-- Options will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addQuestionOption(${questionId})">+ Agregar Opci√≥n</button>
                    </div>
                `;
            } else if (type === 'number') {
                configHtml = `
                    <div class="form-group">
                        <label>Valor m√≠nimo:</label>
                        <input type="number" class="min-value" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Valor m√°ximo:</label>
                        <input type="number" class="max-value" placeholder="100">
                    </div>
                `;
            }
            
            configDiv.innerHTML = configHtml;
            
            // Add default options for selection types
            if (type === 'select' || type === 'radio' || type === 'checkbox') {
                addQuestionOption(questionId, 'S√≠', 10);
                addQuestionOption(questionId, 'No', 0);
            }
        }

        function addQuestionOption(questionId, text = '', score = 0) {
            const optionsList = document.querySelector(`[data-question-id="${questionId}"] .options-list`);
            const optionId = Date.now() + Math.random();
            
            const optionHtml = `
                <div class="option-item" data-option-id="${optionId}" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                    <input type="text" placeholder="Texto de la opci√≥n" value="${text}" style="flex: 1;">
                    <input type="number" placeholder="Puntos" value="${score}" style="width: 80px;" class="option-score">
                    <button type="button" class="btn-danger" onclick="removeOption(${optionId})" style="padding: 5px 10px;">√ó</button>
                </div>
            `;
            
            optionsList.insertAdjacentHTML('beforeend', optionHtml);
        }

        function removeOption(optionId) {
            const option = document.querySelector(`[data-option-id="${optionId}"]`);
            if (option) option.remove();
        }

        function toggleScoring(questionId) {
            const questionDiv = document.querySelector(`[data-question-id="${questionId}"]`);
            const scored = questionDiv.querySelector('.question-scored').checked;
            const configDiv = questionDiv.querySelector('.question-config');
            
            if (scored) {
                const scoringHtml = `
                    <div class="scoring-config">
                        <label>Puntuaci√≥n m√°xima:</label>
                        <input type="number" class="max-score" placeholder="10" value="10">
                    </div>
                `;
                configDiv.insertAdjacentHTML('beforeend', scoringHtml);
            } else {
                const scoringConfig = configDiv.querySelector('.scoring-config');
                if (scoringConfig) scoringConfig.remove();
            }
        }

        function saveTemplate() {
            const name = document.getElementById('templateName').value;
            const category = document.getElementById('templateCategory').value;
            const description = document.getElementById('templateDescription').value;
            
            if (!name.trim()) {
                alert('Por favor ingresa un nombre para la plantilla');
                return;
            }
            
            // Collect sections data
            const sections = [];
            document.querySelectorAll('.template-section').forEach(sectionDiv => {
                const sectionData = {
                    name: sectionDiv.querySelector('.section-name').value,
                    description: sectionDiv.querySelector('.section-description').value,
                    repeatable: sectionDiv.querySelector('.section-repeatable').checked,
                    questions: []
                };
                
                // Collect questions for this section
                sectionDiv.querySelectorAll('.template-question').forEach(questionDiv => {
                    const questionData = {
                        text: questionDiv.querySelector('.question-text').value,
                        type: questionDiv.querySelector('.question-type').value,
                        required: questionDiv.querySelector('.question-required').checked,
                        scored: questionDiv.querySelector('.question-scored').checked
                    };
                    
                    // Add type-specific configuration
                    if (questionData.type === 'select' || questionData.type === 'radio' || questionData.type === 'checkbox') {
                        questionData.options = [];
                        questionDiv.querySelectorAll('.option-item').forEach(optionDiv => {
                            questionData.options.push({
                                text: optionDiv.querySelector('input[type="text"]').value,
                                score: parseInt(optionDiv.querySelector('.option-score').value) || 0
                            });
                        });
                    } else if (questionData.type === 'number') {
                        const minValue = questionDiv.querySelector('.min-value');
                        const maxValue = questionDiv.querySelector('.max-value');
                        questionData.validation = {
                            min: minValue ? parseInt(minValue.value) : undefined,
                            max: maxValue ? parseInt(maxValue.value) : undefined
                        };
                    }
                    
                    if (questionData.scored) {
                        const maxScore = questionDiv.querySelector('.max-score');
                        questionData.scoring = {
                            maxScore: maxScore ? parseInt(maxScore.value) : 10
                        };
                    }
                    
                    sectionData.questions.push(questionData);
                });
                
                sections.push(sectionData);
            });
            
            const templateData = {
                id: currentEditingTemplate ? currentEditingTemplate.id : ++templateCounter,
                name,
                category,
                description,
                sections,
                createdAt: currentEditingTemplate ? currentEditingTemplate.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (currentEditingTemplate) {
                // Update existing template
                const index = templates.findIndex(t => t.id === currentEditingTemplate.id);
                templates[index] = templateData;
            } else {
                // Add new template
                templates.push(templateData);
            }
            
            localStorage.setItem('templates', JSON.stringify(templates));
            localStorage.setItem('templateCounter', templateCounter.toString());
            
            closeTemplateBuilder();
            loadTemplates();
            alert(currentEditingTemplate ? 'Plantilla actualizada exitosamente' : 'Plantilla creada exitosamente');
        }

        function deleteTemplate(templateId) {
            if (!confirm('¬øEst√°s seguro de eliminar esta plantilla? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            templates = templates.filter(t => t.id !== templateId);
            localStorage.setItem('templates', JSON.stringify(templates));
            loadTemplates();
        }

        function useTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            // Switch to audit tab and load template
            switchTab('audit');
            loadTemplateForAudit(template);
        }

        function loadTemplateForAudit(template) {
            // This will be implemented when we enhance the audit form
            alert(`Cargando plantilla "${template.name}" para nueva auditor√≠a.\nEsta funcionalidad se implementar√° en la siguiente actualizaci√≥n.`);
        }

        function importTemplate() {
            alert('Funcionalidad de importaci√≥n de plantillas estar√° disponible pr√≥ximamente.');
        }

        // Funciones de navegaci√≥n
        function switchTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar la pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Cargar contenido espec√≠fico
            if (tabName === 'results') {
                loadResults();
            } else if (tabName === 'templates') {
                loadTemplates();
            }
        }

        // Funciones de auditor√≠a
        document.getElementById('auditForm').addEventListener('submit', function(e) {
            e.preventDefault();
            startAudit();
        });

        function startAudit() {
            const formData = new FormData(document.getElementById('auditForm'));
            const auditData = {
                id: ++auditCounter,
                type: formData.get('auditType'),
                company: formData.get('companyName'),
                startDate: formData.get('auditStartDate'),
                endDate: formData.get('auditEndDate'),
                scope: formData.get('auditScope'),
                auditor: formData.get('auditor'),
                status: 'En Progreso',
                createdAt: new Date().toISOString(),
                progress: 0
            };

            currentAudits.push(auditData);
            localStorage.setItem('audits', JSON.stringify(currentAudits));
            localStorage.setItem('auditCounter', auditCounter.toString());

            // Mostrar progreso
            document.getElementById('auditProgress').classList.remove('hidden');
            simulateAuditProgress(auditData.id);
        }

        function simulateAuditProgress(auditId) {
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            const steps = [
                'Analizando documentos financieros...',
                'Verificando controles internos...',
                'Evaluando riesgos identificados...',
                'Generando hallazgos...',
                'Completando auditor√≠a...'
            ];

            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 100) progress = 100;

                progressFill.style.width = progress + '%';
                const stepIndex = Math.floor((progress / 100) * steps.length);
                if (stepIndex < steps.length) {
                    progressText.textContent = steps[stepIndex];
                }

                if (progress >= 100) {
                    clearInterval(interval);
                    completeAudit(auditId);
                }
            }, 1000);
        }

        function completeAudit(auditId) {
            // Actualizar el estado de la auditor√≠a
            const auditIndex = currentAudits.findIndex(a => a.id === auditId);
            if (auditIndex !== -1) {
                currentAudits[auditIndex].status = 'Completada';
                currentAudits[auditIndex].progress = 100;
                currentAudits[auditIndex].completedAt = new Date().toISOString();
                
                // Generar hallazgos de ejemplo
                currentAudits[auditIndex].findings = generateSampleFindings();
                
                localStorage.setItem('audits', JSON.stringify(currentAudits));
            }

            document.getElementById('progressText').textContent = '¬°Auditor√≠a completada con √©xito!';
            
            setTimeout(() => {
                document.getElementById('auditProgress').classList.add('hidden');
                document.getElementById('auditForm').reset();
                alert('¬°Auditor√≠a completada! Puedes ver los resultados en la pesta√±a "Resultados".');
            }, 2000);
        }

        function generateSampleFindings() {
            const findings = [
                {
                    type: 'error',
                    title: 'Control de acceso insuficiente',
                    description: 'Se encontraron privilegios de usuario excesivos en el sistema contable.',
                    recommendation: 'Implementar principio de menor privilegio.',
                    severity: 'Alta'
                },
                {
                    type: 'warning',
                    title: 'Documentaci√≥n incompleta',
                    description: 'Faltan pol√≠ticas actualizadas para el manejo de efectivo.',
                    recommendation: 'Actualizar manual de procedimientos.',
                    severity: 'Media'
                },
                {
                    type: 'info',
                    title: 'Proceso eficiente identificado',
                    description: 'El proceso de reconciliaci√≥n bancaria es robusto.',
                    recommendation: 'Mantener el proceso actual.',
                    severity: 'Baja'
                }
            ];
            
            return findings;
        }

        function loadResults() {
            const container = document.getElementById('resultsContainer');
            
            if (currentAudits.length === 0) {
                container.innerHTML = '<p>No hay auditor√≠as completadas a√∫n.</p>';
                return;
            }

            let html = '';
            currentAudits.forEach(audit => {
                html += `
                    <div class="audit-results">
                        <h3>${audit.company} - ${audit.type}</h3>
                        <p><strong>Estado:</strong> ${audit.status}</p>
                        <p><strong>Auditor:</strong> ${audit.auditor}</p>
                        <p><strong>Per√≠odo:</strong> ${audit.startDate} al ${audit.endDate}</p>
                        <p><strong>Fecha de creaci√≥n:</strong> ${new Date(audit.createdAt).toLocaleDateString()}</p>
                        
                        ${audit.findings ? renderFindings(audit.findings) : ''}
                        
                        <button class="btn btn-secondary" onclick="downloadReport(${audit.id})">
                            Descargar Reporte
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderFindings(findings) {
            let html = '<h4>Hallazgos:</h4>';
            findings.forEach(finding => {
                html += `
                    <div class="result-item ${finding.type}">
                        <h5>${finding.title}</h5>
                        <p><strong>Descripci√≥n:</strong> ${finding.description}</p>
                        <p><strong>Recomendaci√≥n:</strong> ${finding.recommendation}</p>
                        <p><strong>Severidad:</strong> ${finding.severity}</p>
                    </div>
                `;
            });
            return html;
        }

        function generateReport(type) {
            alert(`Generando reporte ${type}... Esta funcionalidad estar√° disponible pr√≥ximamente.`);
        }

        function downloadReport(auditId) {
            const audit = currentAudits.find(a => a.id === auditId);
            if (!audit) return;

            const reportContent = `
REPORTE DE AUDITOR√çA
====================

Empresa: ${audit.company}
Tipo de Auditor√≠a: ${audit.type}
Auditor: ${audit.auditor}
Per√≠odo: ${audit.startDate} al ${audit.endDate}
Estado: ${audit.status}

HALLAZGOS:
${audit.findings ? audit.findings.map(f => `
- ${f.title} (${f.severity})
  Descripci√≥n: ${f.description}
  Recomendaci√≥n: ${f.recommendation}
`).join('\n') : 'No hay hallazgos registrados.'}

Generado el: ${new Date().toLocaleString()}
            `;

            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_auditoria_${audit.company}_${audit.id}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function saveSettings() {
            const settings = {
                language: document.getElementById('language').value,
                defaultAuditor: document.getElementById('defaultAuditor').value,
                companyInfo: document.getElementById('companyInfo').value
            };
            
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('Configuraci√≥n guardada exitosamente.');
        }

        // Cargar configuraci√≥n al iniciar
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('settings') || '{}');
            
            if (settings.language) {
                document.getElementById('language').value = settings.language;
            }
            if (settings.defaultAuditor) {
                document.getElementById('defaultAuditor').value = settings.defaultAuditor;
                document.getElementById('auditor').value = settings.defaultAuditor;
            }
            if (settings.companyInfo) {
                document.getElementById('companyInfo').value = settings.companyInfo;
            }
        }

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadResults();
            loadTemplates();
        });
    </script>
</body>
</html>