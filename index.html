<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeAuditor - Herramienta de Auditor√≠a Gratuita</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .nav-tab:hover {
            background: #f5f5f5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .audit-results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .result-item.warning {
            border-left-color: #ffc107;
        }

        .result-item.error {
            border-left-color: #dc3545;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .hidden {
            display: none;
        }

        .modal.hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .template-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .template-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-controls {
            display: flex;
            gap: 10px;
        }

        .section-controls button {
            padding: 5px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .template-question {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .question-controls {
            display: flex;
            gap: 5px;
        }

        .question-controls button {
            padding: 2px 8px;
            font-size: 0.7rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .dynamic-audit-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .dynamic-audit-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .audit-question {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .audit-question label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }

        .audit-question.required label::after {
            content: " *";
            color: #dc3545;
        }

        .score-summary {
            display: flex;
            gap: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .score-item span:first-child {
            font-size: 0.9rem;
            color: #666;
        }

        .score-item span:last-child {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .repeatable-section {
            border: 2px dashed #ccc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            position: relative;
        }

        .repeatable-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-instance-controls {
            display: flex;
            gap: 10px;
        }

        .reports-summary {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            font-size: 2rem;
            margin-bottom: 5px;
            color: #667eea;
        }

        .stat-card p {
            color: #666;
            margin: 0;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .score-summary {
                flex-direction: column;
                gap: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç FreeAuditor</h1>
            <p>Herramienta de Auditor√≠a Gratuita - Analiza y mejora tu negocio</p>
        </div>

        <div class="main-content">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('audit')">Nueva Auditor√≠a</button>
                <button class="nav-tab" onclick="switchTab('templates')">Plantillas</button>
                <button class="nav-tab" onclick="switchTab('results')">Resultados</button>
                <button class="nav-tab" onclick="switchTab('reports')">Reportes</button>
                <button class="nav-tab" onclick="switchTab('settings')">Configuraci√≥n</button>
            </div>

            <!-- Nueva Auditor√≠a Tab -->
            <div id="audit" class="tab-content active">
                <h2>Crear Nueva Auditor√≠a</h2>
                
                <!-- Template Selection -->
                <div class="form-group">
                    <label for="templateSelect">Usar Plantilla (Opcional):</label>
                    <select id="templateSelect" onchange="loadSelectedTemplate()">
                        <option value="">Auditor√≠a personalizada (sin plantilla)</option>
                        <!-- Templates will be loaded here -->
                    </select>
                </div>

                <form id="auditForm">
                    <div class="form-group">
                        <label for="auditType">Tipo de Auditor√≠a:</label>
                        <select id="auditType" name="auditType">
                            <option value="financial">Auditor√≠a Financiera</option>
                            <option value="security">Auditor√≠a de Seguridad</option>
                            <option value="compliance">Auditor√≠a de Cumplimiento</option>
                            <option value="operational">Auditor√≠a Operacional</option>
                            <option value="it">Auditor√≠a de TI</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="companyName">Nombre de la Empresa:</label>
                        <input type="text" id="companyName" name="companyName" required>
                    </div>

                    <div class="form-group">
                        <label for="auditPeriod">Per√≠odo de Auditor√≠a:</label>
                        <input type="date" id="auditStartDate" name="auditStartDate" style="width: 48%; margin-right: 4%;" required>
                        <input type="date" id="auditEndDate" name="auditEndDate" style="width: 48%;" required>
                    </div>

                    <div class="form-group">
                        <label for="auditScope">Alcance de la Auditor√≠a:</label>
                        <textarea id="auditScope" name="auditScope" rows="4" placeholder="Describe el alcance y objetivos de la auditor√≠a..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="auditor">Auditor Responsable:</label>
                        <input type="text" id="auditor" name="auditor" required>
                    </div>

                    <!-- Dynamic audit form will be inserted here -->
                    <div id="dynamicAuditForm"></div>

                    <button type="submit" class="btn">Iniciar Auditor√≠a</button>
                </form>

                <div id="auditProgress" class="hidden">
                    <h3>Progreso de la Auditor√≠a</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">Iniciando auditor√≠a...</p>
                    
                    <!-- Real-time scoring display -->
                    <div id="scoringDisplay" class="hidden">
                        <h4>Puntuaci√≥n Actual</h4>
                        <div class="score-summary">
                            <div class="score-item">
                                <span>Puntos obtenidos: </span>
                                <span id="currentScore">0</span>
                            </div>
                            <div class="score-item">
                                <span>Puntos totales: </span>
                                <span id="maxScore">0</span>
                            </div>
                            <div class="score-item">
                                <span>Porcentaje: </span>
                                <span id="scorePercentage">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plantillas Tab -->
            <div id="templates" class="tab-content">
                <h2>Gesti√≥n de Plantillas</h2>
                <div class="template-controls" style="margin-bottom: 20px;">
                    <button class="btn" onclick="showTemplateBuilder()">+ Nueva Plantilla</button>
                    <button class="btn btn-secondary" onclick="importTemplate()">Importar Plantilla</button>
                </div>

                <div id="templatesList">
                    <div class="grid" id="templatesGrid">
                        <!-- Templates will be loaded here -->
                    </div>
                </div>

                <!-- Template Builder Modal -->
                <div id="templateBuilderModal" class="modal hidden">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="templateBuilderTitle">Nueva Plantilla</h3>
                            <button class="close-btn" onclick="closeTemplateBuilder()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="templateName">Nombre de la Plantilla:</label>
                                <input type="text" id="templateName" placeholder="Ej: Auditor√≠a de Seguridad Industrial">
                            </div>
                            <div class="form-group">
                                <label for="templateCategory">Categor√≠a:</label>
                                <select id="templateCategory">
                                    <option value="safety">Seguridad</option>
                                    <option value="quality">Calidad</option>
                                    <option value="environment">Medio Ambiente</option>
                                    <option value="compliance">Cumplimiento</option>
                                    <option value="operational">Operacional</option>
                                    <option value="financial">Financiera</option>
                                    <option value="it">Tecnolog√≠a</option>
                                    <option value="custom">Personalizada</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="templateDescription">Descripci√≥n:</label>
                                <textarea id="templateDescription" rows="3" placeholder="Describe el prop√≥sito y alcance de esta plantilla..."></textarea>
                            </div>

                            <h4>Secciones de la Plantilla</h4>
                            <div id="templateSections">
                                <!-- Sections will be added here -->
                            </div>
                            <button class="btn btn-secondary" onclick="addTemplateSection()">+ Agregar Secci√≥n</button>

                            <div class="modal-actions">
                                <button class="btn" onclick="saveTemplate()">Guardar Plantilla</button>
                                <button class="btn btn-secondary" onclick="closeTemplateBuilder()">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resultados Tab -->
            <div id="results" class="tab-content">
                <h2>Resultados de Auditor√≠as</h2>
                <div id="resultsContainer">
                    <p>No hay auditor√≠as completadas a√∫n.</p>
                </div>
            </div>

            <!-- Reportes Tab -->
            <div id="reports" class="tab-content">
                <h2>Generar Reportes</h2>
                
                <div class="form-group">
                    <label for="reportAuditSelect">Seleccionar Auditor√≠a:</label>
                    <select id="reportAuditSelect">
                        <option value="">Seleccionar auditor√≠a...</option>
                        <!-- Audits will be loaded here -->
                    </select>
                </div>
                
                <div class="grid">
                    <div class="card">
                        <h3>üìä Reporte Ejecutivo</h3>
                        <p>Resumen de hallazgos principales y recomendaciones con m√©tricas de cumplimiento.</p>
                        <button class="btn" onclick="generateReport('executive')">Generar</button>
                    </div>
                    <div class="card">
                        <h3>üìã Reporte Detallado</h3>
                        <p>An√°lisis completo con todos los hallazgos, evidencias y respuestas detalladas.</p>
                        <button class="btn" onclick="generateReport('detailed')">Generar</button>
                    </div>
                    <div class="card">
                        <h3>‚úÖ Reporte de Cumplimiento</h3>
                        <p>Estado de cumplimiento de normativas y regulaciones con scoring detallado.</p>
                        <button class="btn" onclick="generateReport('compliance')">Generar</button>
                    </div>
                    <div class="card">
                        <h3>üìà Dashboard de Auditor√≠as</h3>
                        <p>Resumen visual de todas las auditor√≠as con estad√≠sticas y tendencias.</p>
                        <button class="btn" onclick="generateReport('dashboard')">Generar</button>
                    </div>
                </div>

                <!-- Reports Summary -->
                <div id="reportsSummary" class="reports-summary hidden">
                    <h3>Resumen de Auditor√≠as</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4 id="totalAudits">0</h4>
                            <p>Total Auditor√≠as</p>
                        </div>
                        <div class="stat-card">
                            <h4 id="completedAudits">0</h4>
                            <p>Completadas</p>
                        </div>
                        <div class="stat-card">
                            <h4 id="averageScore">0%</h4>
                            <p>Puntuaci√≥n Promedio</p>
                        </div>
                        <div class="stat-card">
                            <h4 id="templatesUsed">0</h4>
                            <p>Plantillas Utilizadas</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuraci√≥n Tab -->
            <div id="settings" class="tab-content">
                <h2>Configuraci√≥n</h2>
                <div class="form-group">
                    <label for="language">Idioma:</label>
                    <select id="language">
                        <option value="es">Espa√±ol</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="defaultAuditor">Auditor por Defecto:</label>
                    <input type="text" id="defaultAuditor" placeholder="Nombre del auditor por defecto">
                </div>
                <div class="form-group">
                    <label for="companyInfo">Informaci√≥n de la Empresa:</label>
                    <textarea id="companyInfo" rows="3" placeholder="Informaci√≥n general de tu empresa..."></textarea>
                </div>
                <button class="btn" onclick="saveSettings()">Guardar Configuraci√≥n</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentAudits = JSON.parse(localStorage.getItem('audits') || '[]');
        let auditCounter = parseInt(localStorage.getItem('auditCounter') || '0');
        let templates = JSON.parse(localStorage.getItem('templates') || '[]');
        let templateCounter = parseInt(localStorage.getItem('templateCounter') || '0');
        let currentEditingTemplate = null;
        let currentAuditTemplate = null;
        let currentAuditResponses = {};
        let currentScore = 0;
        let maxScore = 0;

        // Funciones de auditor√≠a din√°mica
        function loadTemplateSelector() {
            const templateSelect = document.getElementById('templateSelect');
            templateSelect.innerHTML = '<option value="">Auditor√≠a personalizada (sin plantilla)</option>';
            
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name} (${getCategoryName(template.category)})`;
                templateSelect.appendChild(option);
            });
        }

        function loadSelectedTemplate() {
            const templateSelect = document.getElementById('templateSelect');
            const templateId = parseInt(templateSelect.value);
            const dynamicForm = document.getElementById('dynamicAuditForm');
            
            if (!templateId) {
                dynamicForm.innerHTML = '';
                currentAuditTemplate = null;
                return;
            }
            
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            currentAuditTemplate = template;
            currentAuditResponses = {};
            currentScore = 0;
            maxScore = 0;
            
            // Update audit type to match template category
            document.getElementById('auditType').value = template.category;
            
            generateDynamicAuditForm(template);
        }

        function generateDynamicAuditForm(template) {
            const dynamicForm = document.getElementById('dynamicAuditForm');
            dynamicForm.innerHTML = '<h3>Contenido de la Auditor√≠a</h3>';
            
            template.sections.forEach((section, sectionIndex) => {
                const sectionDiv = createAuditSection(section, sectionIndex);
                dynamicForm.appendChild(sectionDiv);
            });
            
            // Calculate total possible score
            calculateMaxScore(template);
        }

        function createAuditSection(section, sectionIndex) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'dynamic-audit-section';
            sectionDiv.setAttribute('data-section-index', sectionIndex);
            
            let sectionHtml = `
                <h4>${section.name}</h4>
                <p>${section.description}</p>
            `;
            
            if (section.repeatable) {
                sectionHtml += `
                    <div class="repeatable-section-controls">
                        <button type="button" class="btn btn-secondary" onclick="addSectionInstance(${sectionIndex})">
                            + Agregar ${section.name}
                        </button>
                    </div>
                    <div class="section-instances" data-section-index="${sectionIndex}">
                        <!-- Section instances will be added here -->
                    </div>
                `;
                sectionDiv.innerHTML = sectionHtml;
                
                // Add first instance
                setTimeout(() => addSectionInstance(sectionIndex), 100);
            } else {
                const questionsDiv = document.createElement('div');
                questionsDiv.className = 'section-questions';
                
                section.questions.forEach((question, questionIndex) => {
                    const questionDiv = createAuditQuestion(question, sectionIndex, questionIndex);
                    questionsDiv.appendChild(questionDiv);
                });
                
                sectionDiv.innerHTML = sectionHtml;
                sectionDiv.appendChild(questionsDiv);
            }
            
            return sectionDiv;
        }

        function addSectionInstance(sectionIndex) {
            const section = currentAuditTemplate.sections[sectionIndex];
            const instancesContainer = document.querySelector(`[data-section-index="${sectionIndex}"] .section-instances`);
            
            const instanceIndex = instancesContainer.children.length;
            const instanceDiv = document.createElement('div');
            instanceDiv.className = 'repeatable-section';
            instanceDiv.setAttribute('data-instance-index', instanceIndex);
            
            instanceDiv.innerHTML = `
                <div class="repeatable-section-header">
                    <h5>${section.name} #${instanceIndex + 1}</h5>
                    <div class="section-instance-controls">
                        <button type="button" class="btn btn-danger" onclick="removeSectionInstance(${sectionIndex}, ${instanceIndex})">
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
            
            const questionsDiv = document.createElement('div');
            questionsDiv.className = 'instance-questions';
            
            section.questions.forEach((question, questionIndex) => {
                const questionDiv = createAuditQuestion(question, sectionIndex, questionIndex, instanceIndex);
                questionsDiv.appendChild(questionDiv);
            });
            
            instanceDiv.appendChild(questionsDiv);
            instancesContainer.appendChild(instanceDiv);
        }

        function removeSectionInstance(sectionIndex, instanceIndex) {
            const instanceDiv = document.querySelector(`[data-section-index="${sectionIndex}"] .section-instances [data-instance-index="${instanceIndex}"]`);
            if (instanceDiv && confirm('¬øEliminar esta instancia de la secci√≥n?')) {
                instanceDiv.remove();
                // Recalculate scores
                updateAuditScore();
            }
        }

        function createAuditQuestion(question, sectionIndex, questionIndex, instanceIndex = null) {
            const questionDiv = document.createElement('div');
            questionDiv.className = `audit-question ${question.required ? 'required' : ''}`;
            
            const questionId = `q_${sectionIndex}_${questionIndex}${instanceIndex !== null ? '_' + instanceIndex : ''}`;
            const questionName = `question_${sectionIndex}_${questionIndex}${instanceIndex !== null ? '_' + instanceIndex : ''}`;
            
            let questionHtml = `<label for="${questionId}">${question.text}</label>`;
            
            switch (question.type) {
                case 'text':
                    questionHtml += `<input type="text" id="${questionId}" name="${questionName}" ${question.required ? 'required' : ''}>`;
                    break;
                    
                case 'number':
                    const min = question.validation?.min || '';
                    const max = question.validation?.max || '';
                    questionHtml += `<input type="number" id="${questionId}" name="${questionName}" min="${min}" max="${max}" ${question.required ? 'required' : ''}>`;
                    break;
                    
                case 'date':
                    questionHtml += `<input type="date" id="${questionId}" name="${questionName}" ${question.required ? 'required' : ''}>`;
                    break;
                    
                case 'select':
                    questionHtml += `<select id="${questionId}" name="${questionName}" ${question.required ? 'required' : ''} onchange="updateQuestionScore('${questionId}', ${sectionIndex}, ${questionIndex}, ${instanceIndex})">`;
                    questionHtml += '<option value="">Seleccionar...</option>';
                    question.options.forEach(option => {
                        questionHtml += `<option value="${option.text}" data-score="${option.score}">${option.text}</option>`;
                    });
                    questionHtml += '</select>';
                    break;
                    
                case 'radio':
                    question.options.forEach((option, optionIndex) => {
                        questionHtml += `
                            <label style="font-weight: normal; margin-bottom: 5px; display: flex; align-items: center;">
                                <input type="radio" name="${questionName}" value="${option.text}" data-score="${option.score}" 
                                       onchange="updateQuestionScore('${questionId}', ${sectionIndex}, ${questionIndex}, ${instanceIndex})" style="margin-right: 8px;">
                                ${option.text}
                            </label>
                        `;
                    });
                    break;
                    
                case 'checkbox':
                    question.options.forEach((option, optionIndex) => {
                        const checkboxId = `${questionId}_${optionIndex}`;
                        questionHtml += `
                            <label style="font-weight: normal; margin-bottom: 5px; display: flex; align-items: center;">
                                <input type="checkbox" id="${checkboxId}" name="${questionName}[]" value="${option.text}" data-score="${option.score}"
                                       onchange="updateQuestionScore('${questionId}', ${sectionIndex}, ${questionIndex}, ${instanceIndex})" style="margin-right: 8px;">
                                ${option.text}
                            </label>
                        `;
                    });
                    break;
                    
                case 'photo':
                    questionHtml += `
                        <input type="file" id="${questionId}" name="${questionName}" accept="image/*" capture="camera">
                        <small>Tomar foto o subir imagen</small>
                    `;
                    break;
            }
            
            if (question.scored) {
                questionHtml += `
                    <div class="question-scoring" style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <span>Puntuaci√≥n m√°xima: ${question.scoring?.maxScore || 10}</span>
                        <span id="score_${questionId}" style="margin-left: 15px; font-weight: bold;">Puntos: 0</span>
                    </div>
                `;
            }
            
            questionDiv.innerHTML = questionHtml;
            return questionDiv;
        }

        function updateQuestionScore(questionId, sectionIndex, questionIndex, instanceIndex) {
            const question = currentAuditTemplate.sections[sectionIndex].questions[questionIndex];
            if (!question.scored) return;
            
            let score = 0;
            const responseKey = `${sectionIndex}_${questionIndex}${instanceIndex !== null ? '_' + instanceIndex : ''}`;
            
            if (question.type === 'select') {
                const select = document.getElementById(questionId);
                const selectedOption = select.selectedOptions[0];
                if (selectedOption) {
                    score = parseInt(selectedOption.getAttribute('data-score')) || 0;
                    currentAuditResponses[responseKey] = {
                        value: selectedOption.value,
                        score: score
                    };
                }
            } else if (question.type === 'radio') {
                const radios = document.querySelectorAll(`input[name="${questionId.replace('q_', 'question_')}"]`);
                radios.forEach(radio => {
                    if (radio.checked) {
                        score = parseInt(radio.getAttribute('data-score')) || 0;
                        currentAuditResponses[responseKey] = {
                            value: radio.value,
                            score: score
                        };
                    }
                });
            } else if (question.type === 'checkbox') {
                const checkboxes = document.querySelectorAll(`input[name="${questionId.replace('q_', 'question_')}[]"]`);
                let values = [];
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        score += parseInt(checkbox.getAttribute('data-score')) || 0;
                        values.push(checkbox.value);
                    }
                });
                currentAuditResponses[responseKey] = {
                    value: values,
                    score: score
                };
            }
            
            // Update score display for this question
            const scoreDisplay = document.getElementById(`score_${questionId}`);
            if (scoreDisplay) {
                scoreDisplay.textContent = `Puntos: ${score}`;
            }
            
            // Update total score
            updateAuditScore();
        }

        function updateAuditScore() {
            currentScore = 0;
            Object.values(currentAuditResponses).forEach(response => {
                currentScore += response.score || 0;
            });
            
            const scoreDisplay = document.getElementById('scoringDisplay');
            if (scoreDisplay && currentAuditTemplate) {
                document.getElementById('currentScore').textContent = currentScore;
                document.getElementById('maxScore').textContent = maxScore;
                document.getElementById('scorePercentage').textContent = maxScore > 0 ? Math.round((currentScore / maxScore) * 100) + '%' : '0%';
                scoreDisplay.classList.remove('hidden');
            }
        }

        function calculateMaxScore(template) {
            maxScore = 0;
            template.sections.forEach(section => {
                section.questions.forEach(question => {
                    if (question.scored) {
                        if (question.type === 'checkbox') {
                            // For checkboxes, sum all possible scores
                            question.options.forEach(option => {
                                maxScore += option.score || 0;
                            });
                        } else if (question.options) {
                            // For select/radio, take the highest score
                            const maxOptionScore = Math.max(...question.options.map(opt => opt.score || 0));
                            maxScore += maxOptionScore;
                        } else {
                            // For other types, use the question's max score
                            maxScore += question.scoring?.maxScore || 10;
                        }
                    }
                });
            });
        }

        function loadTemplateForAudit(template) {
            // Switch to audit tab and load template
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('audit').classList.add('active');
            document.querySelectorAll('.nav-tab')[0].classList.add('active');
            
            setTimeout(() => {
                loadTemplateSelector();
                document.getElementById('templateSelect').value = template.id;
                loadSelectedTemplate();
            }, 100);
        }

        // Funciones de gesti√≥n de plantillas
        function loadTemplates() {
            const grid = document.getElementById('templatesGrid');
            
            if (templates.length === 0) {
                grid.innerHTML = '<p>No hay plantillas creadas a√∫n. <a href="#" onclick="showTemplateBuilder()">Crear primera plantilla</a></p>';
                return;
            }

            let html = '';
            templates.forEach(template => {
                html += `
                    <div class="card">
                        <h3>${template.name}</h3>
                        <p><strong>Categor√≠a:</strong> ${getCategoryName(template.category)}</p>
                        <p>${template.description}</p>
                        <p><strong>Secciones:</strong> ${template.sections ? template.sections.length : 0}</p>
                        <p><strong>Creada:</strong> ${new Date(template.createdAt).toLocaleDateString()}</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="useTemplate(${template.id})" style="margin-right: 10px;">
                                Usar Plantilla
                            </button>
                            <button class="btn btn-info" onclick="editTemplate(${template.id})" style="margin-right: 10px;">
                                Editar
                            </button>
                            <button class="btn btn-danger" onclick="deleteTemplate(${template.id})">
                                Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function getCategoryName(category) {
            const categories = {
                'safety': 'Seguridad',
                'quality': 'Calidad',
                'environment': 'Medio Ambiente',
                'compliance': 'Cumplimiento',
                'operational': 'Operacional',
                'financial': 'Financiera',
                'it': 'Tecnolog√≠a',
                'custom': 'Personalizada'
            };
            return categories[category] || category;
        }

        function showTemplateBuilder() {
            currentEditingTemplate = null;
            document.getElementById('templateBuilderTitle').textContent = 'Nueva Plantilla';
            document.getElementById('templateName').value = '';
            document.getElementById('templateCategory').value = 'safety';
            document.getElementById('templateDescription').value = '';
            document.getElementById('templateSections').innerHTML = '';
            document.getElementById('templateBuilderModal').classList.remove('hidden');
            
            // Add initial section
            addTemplateSection();
        }

        function editTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;

            currentEditingTemplate = template;
            document.getElementById('templateBuilderTitle').textContent = 'Editar Plantilla';
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateCategory').value = template.category;
            document.getElementById('templateDescription').value = template.description;
            
            // Load sections
            const sectionsContainer = document.getElementById('templateSections');
            sectionsContainer.innerHTML = '';
            
            if (template.sections) {
                template.sections.forEach(section => {
                    addTemplateSection(section);
                });
            }
            
            document.getElementById('templateBuilderModal').classList.remove('hidden');
        }

        function closeTemplateBuilder() {
            document.getElementById('templateBuilderModal').classList.add('hidden');
            currentEditingTemplate = null;
        }

        function addTemplateSection(sectionData = null) {
            const sectionsContainer = document.getElementById('templateSections');
            const sectionId = Date.now();
            
            const sectionHtml = `
                <div class="template-section" data-section-id="${sectionId}">
                    <div class="template-section-header">
                        <input type="text" placeholder="Nombre de la secci√≥n" class="section-name" value="${sectionData ? sectionData.name : ''}" style="font-weight: bold; font-size: 1.1rem;">
                        <div class="section-controls">
                            <button class="btn-info" onclick="addQuestion(${sectionId})">+ Pregunta</button>
                            <button class="btn-danger" onclick="removeSection(${sectionId})">Eliminar Secci√≥n</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Descripci√≥n de la secci√≥n:</label>
                        <textarea class="section-description" rows="2" placeholder="Describe qu√© eval√∫a esta secci√≥n...">${sectionData ? sectionData.description : ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" class="section-repeatable" ${sectionData && sectionData.repeatable ? 'checked' : ''}> 
                            Secci√≥n repetible (para elementos m√∫ltiples)
                        </label>
                    </div>
                    
                    <h5>Preguntas:</h5>
                    <div class="questions-container" data-section-id="${sectionId}">
                        <!-- Questions will be added here -->
                    </div>
                </div>
            `;
            
            sectionsContainer.insertAdjacentHTML('beforeend', sectionHtml);
            
            // Load questions if editing
            if (sectionData && sectionData.questions) {
                sectionData.questions.forEach(question => {
                    addQuestion(sectionId, question);
                });
            }
        }

        function removeSection(sectionId) {
            const section = document.querySelector(`[data-section-id="${sectionId}"]`);
            if (section && confirm('¬øEst√°s seguro de eliminar esta secci√≥n?')) {
                section.remove();
            }
        }

        function addQuestion(sectionId, questionData = null) {
            const questionsContainer = document.querySelector(`.questions-container[data-section-id="${sectionId}"]`);
            const questionId = Date.now() + Math.random();
            
            const questionHtml = `
                <div class="template-question" data-question-id="${questionId}">
                    <div class="question-header">
                        <input type="text" placeholder="Texto de la pregunta" class="question-text" value="${questionData ? questionData.text : ''}" style="width: 70%;">
                        <div class="question-controls">
                            <select class="question-type" onchange="updateQuestionType(${questionId})">
                                <option value="text" ${questionData && questionData.type === 'text' ? 'selected' : ''}>Texto</option>
                                <option value="number" ${questionData && questionData.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                                <option value="select" ${questionData && questionData.type === 'select' ? 'selected' : ''}>Selecci√≥n</option>
                                <option value="checkbox" ${questionData && questionData.type === 'checkbox' ? 'selected' : ''}>Casillas</option>
                                <option value="radio" ${questionData && questionData.type === 'radio' ? 'selected' : ''}>Opci√≥n √∫nica</option>
                                <option value="date" ${questionData && questionData.type === 'date' ? 'selected' : ''}>Fecha</option>
                                <option value="photo" ${questionData && questionData.type === 'photo' ? 'selected' : ''}>Foto</option>
                            </select>
                            <button class="btn-danger" onclick="removeQuestion(${questionId})">√ó</button>
                        </div>
                    </div>
                    
                    <div class="question-options">
                        <label>
                            <input type="checkbox" class="question-required" ${questionData && questionData.required ? 'checked' : ''}> 
                            Obligatoria
                        </label>
                        <label style="margin-left: 15px;">
                            <input type="checkbox" class="question-scored" onchange="toggleScoring(${questionId})" ${questionData && questionData.scored ? 'checked' : ''}> 
                            Puntuable
                        </label>
                    </div>
                    
                    <div class="question-config" data-question-id="${questionId}">
                        <!-- Configuration specific to question type will be added here -->
                    </div>
                </div>
            `;
            
            questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
            updateQuestionType(questionId);
            
            // Load question data if editing
            if (questionData) {
                setTimeout(() => {
                    if (questionData.options) {
                        const optionsContainer = document.querySelector(`[data-question-id="${questionId}"] .options-list`);
                        if (optionsContainer) {
                            optionsContainer.innerHTML = '';
                            questionData.options.forEach(option => {
                                addQuestionOption(questionId, option.text, option.score);
                            });
                        }
                    }
                    if (questionData.scoring) {
                        const maxScore = document.querySelector(`[data-question-id="${questionId}"] .max-score`);
                        if (maxScore) maxScore.value = questionData.scoring.maxScore || '';
                    }
                }, 100);
            }
        }

        function removeQuestion(questionId) {
            const question = document.querySelector(`[data-question-id="${questionId}"]`);
            if (question && confirm('¬øEliminar esta pregunta?')) {
                question.remove();
            }
        }

        function updateQuestionType(questionId) {
            const questionDiv = document.querySelector(`[data-question-id="${questionId}"]`);
            const type = questionDiv.querySelector('.question-type').value;
            const configDiv = questionDiv.querySelector('.question-config');
            
            let configHtml = '';
            
            if (type === 'select' || type === 'radio' || type === 'checkbox') {
                configHtml = `
                    <div class="form-group">
                        <label>Opciones:</label>
                        <div class="options-list" data-question-id="${questionId}">
                            <!-- Options will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addQuestionOption(${questionId})">+ Agregar Opci√≥n</button>
                    </div>
                `;
            } else if (type === 'number') {
                configHtml = `
                    <div class="form-group">
                        <label>Valor m√≠nimo:</label>
                        <input type="number" class="min-value" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Valor m√°ximo:</label>
                        <input type="number" class="max-value" placeholder="100">
                    </div>
                `;
            }
            
            configDiv.innerHTML = configHtml;
            
            // Add default options for selection types
            if (type === 'select' || type === 'radio' || type === 'checkbox') {
                addQuestionOption(questionId, 'S√≠', 10);
                addQuestionOption(questionId, 'No', 0);
            }
        }

        function addQuestionOption(questionId, text = '', score = 0) {
            const optionsList = document.querySelector(`[data-question-id="${questionId}"] .options-list`);
            const optionId = Date.now() + Math.random();
            
            const optionHtml = `
                <div class="option-item" data-option-id="${optionId}" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                    <input type="text" placeholder="Texto de la opci√≥n" value="${text}" style="flex: 1;">
                    <input type="number" placeholder="Puntos" value="${score}" style="width: 80px;" class="option-score">
                    <button type="button" class="btn-danger" onclick="removeOption(${optionId})" style="padding: 5px 10px;">√ó</button>
                </div>
            `;
            
            optionsList.insertAdjacentHTML('beforeend', optionHtml);
        }

        function removeOption(optionId) {
            const option = document.querySelector(`[data-option-id="${optionId}"]`);
            if (option) option.remove();
        }

        function toggleScoring(questionId) {
            const questionDiv = document.querySelector(`[data-question-id="${questionId}"]`);
            const scored = questionDiv.querySelector('.question-scored').checked;
            const configDiv = questionDiv.querySelector('.question-config');
            
            if (scored) {
                const scoringHtml = `
                    <div class="scoring-config">
                        <label>Puntuaci√≥n m√°xima:</label>
                        <input type="number" class="max-score" placeholder="10" value="10">
                    </div>
                `;
                configDiv.insertAdjacentHTML('beforeend', scoringHtml);
            } else {
                const scoringConfig = configDiv.querySelector('.scoring-config');
                if (scoringConfig) scoringConfig.remove();
            }
        }

        function saveTemplate() {
            const name = document.getElementById('templateName').value;
            const category = document.getElementById('templateCategory').value;
            const description = document.getElementById('templateDescription').value;
            
            if (!name.trim()) {
                alert('Por favor ingresa un nombre para la plantilla');
                return;
            }
            
            // Collect sections data
            const sections = [];
            document.querySelectorAll('.template-section').forEach(sectionDiv => {
                const sectionData = {
                    name: sectionDiv.querySelector('.section-name').value,
                    description: sectionDiv.querySelector('.section-description').value,
                    repeatable: sectionDiv.querySelector('.section-repeatable').checked,
                    questions: []
                };
                
                // Collect questions for this section
                sectionDiv.querySelectorAll('.template-question').forEach(questionDiv => {
                    const questionData = {
                        text: questionDiv.querySelector('.question-text').value,
                        type: questionDiv.querySelector('.question-type').value,
                        required: questionDiv.querySelector('.question-required').checked,
                        scored: questionDiv.querySelector('.question-scored').checked
                    };
                    
                    // Add type-specific configuration
                    if (questionData.type === 'select' || questionData.type === 'radio' || questionData.type === 'checkbox') {
                        questionData.options = [];
                        questionDiv.querySelectorAll('.option-item').forEach(optionDiv => {
                            questionData.options.push({
                                text: optionDiv.querySelector('input[type="text"]').value,
                                score: parseInt(optionDiv.querySelector('.option-score').value) || 0
                            });
                        });
                    } else if (questionData.type === 'number') {
                        const minValue = questionDiv.querySelector('.min-value');
                        const maxValue = questionDiv.querySelector('.max-value');
                        questionData.validation = {
                            min: minValue ? parseInt(minValue.value) : undefined,
                            max: maxValue ? parseInt(maxValue.value) : undefined
                        };
                    }
                    
                    if (questionData.scored) {
                        const maxScore = questionDiv.querySelector('.max-score');
                        questionData.scoring = {
                            maxScore: maxScore ? parseInt(maxScore.value) : 10
                        };
                    }
                    
                    sectionData.questions.push(questionData);
                });
                
                sections.push(sectionData);
            });
            
            const templateData = {
                id: currentEditingTemplate ? currentEditingTemplate.id : ++templateCounter,
                name,
                category,
                description,
                sections,
                createdAt: currentEditingTemplate ? currentEditingTemplate.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (currentEditingTemplate) {
                // Update existing template
                const index = templates.findIndex(t => t.id === currentEditingTemplate.id);
                templates[index] = templateData;
            } else {
                // Add new template
                templates.push(templateData);
            }
            
            localStorage.setItem('templates', JSON.stringify(templates));
            localStorage.setItem('templateCounter', templateCounter.toString());
            
            closeTemplateBuilder();
            loadTemplates();
            alert(currentEditingTemplate ? 'Plantilla actualizada exitosamente' : 'Plantilla creada exitosamente');
        }

        function deleteTemplate(templateId) {
            if (!confirm('¬øEst√°s seguro de eliminar esta plantilla? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            templates = templates.filter(t => t.id !== templateId);
            localStorage.setItem('templates', JSON.stringify(templates));
            loadTemplates();
        }

        function useTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            // Switch to audit tab and load template
            switchTab('audit');
            loadTemplateForAudit(template);
        }

        function loadTemplateForAudit(template) {
            // This will be implemented when we enhance the audit form
            alert(`Cargando plantilla "${template.name}" para nueva auditor√≠a.\nEsta funcionalidad se implementar√° en la siguiente actualizaci√≥n.`);
        }

        function importTemplate() {
            alert('Funcionalidad de importaci√≥n de plantillas estar√° disponible pr√≥ximamente.');
        }

        // Funciones de navegaci√≥n
        function switchTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar la pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Cargar contenido espec√≠fico
            if (tabName === 'results') {
                loadResults();
            } else if (tabName === 'templates') {
                loadTemplates();
            } else if (tabName === 'audit') {
                loadTemplateSelector();
            } else if (tabName === 'reports') {
                loadReportAudits();
            }
        }

        // Funciones de auditor√≠a
        document.getElementById('auditForm').addEventListener('submit', function(e) {
            e.preventDefault();
            startAudit();
        });

        function startAudit() {
            const formData = new FormData(document.getElementById('auditForm'));
            
            // Collect dynamic form responses if using template
            const dynamicResponses = {};
            if (currentAuditTemplate) {
                // Collect all form responses
                const dynamicForm = document.getElementById('dynamicAuditForm');
                const inputs = dynamicForm.querySelectorAll('input, select, textarea');
                
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        if (input.checked) {
                            if (!dynamicResponses[input.name]) {
                                dynamicResponses[input.name] = [];
                            }
                            dynamicResponses[input.name].push(input.value);
                        }
                    } else if (input.type === 'radio') {
                        if (input.checked) {
                            dynamicResponses[input.name] = input.value;
                        }
                    } else if (input.value) {
                        dynamicResponses[input.name] = input.value;
                    }
                });
            }
            
            const auditData = {
                id: ++auditCounter,
                type: formData.get('auditType'),
                company: formData.get('companyName'),
                startDate: formData.get('auditStartDate'),
                endDate: formData.get('auditEndDate'),
                scope: formData.get('auditScope'),
                auditor: formData.get('auditor'),
                status: 'En Progreso',
                createdAt: new Date().toISOString(),
                progress: 0,
                templateId: currentAuditTemplate ? currentAuditTemplate.id : null,
                templateName: currentAuditTemplate ? currentAuditTemplate.name : null,
                responses: dynamicResponses,
                auditResponses: currentAuditResponses,
                score: currentScore,
                maxScore: maxScore,
                percentage: maxScore > 0 ? Math.round((currentScore / maxScore) * 100) : null
            };

            currentAudits.push(auditData);
            localStorage.setItem('audits', JSON.stringify(currentAudits));
            localStorage.setItem('auditCounter', auditCounter.toString());

            // Show progress with scoring if template is used
            document.getElementById('auditProgress').classList.remove('hidden');
            if (currentAuditTemplate) {
                document.getElementById('scoringDisplay').classList.remove('hidden');
                updateAuditScore();
            }
            
            simulateAuditProgress(auditData.id);
        }

        function simulateAuditProgress(auditId) {
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            const steps = [
                'Analizando documentos financieros...',
                'Verificando controles internos...',
                'Evaluando riesgos identificados...',
                'Generando hallazgos...',
                'Completando auditor√≠a...'
            ];

            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 100) progress = 100;

                progressFill.style.width = progress + '%';
                const stepIndex = Math.floor((progress / 100) * steps.length);
                if (stepIndex < steps.length) {
                    progressText.textContent = steps[stepIndex];
                }

                if (progress >= 100) {
                    clearInterval(interval);
                    completeAudit(auditId);
                }
            }, 1000);
        }

        function completeAudit(auditId) {
            // Actualizar el estado de la auditor√≠a
            const auditIndex = currentAudits.findIndex(a => a.id === auditId);
            if (auditIndex !== -1) {
                currentAudits[auditIndex].status = 'Completada';
                currentAudits[auditIndex].progress = 100;
                currentAudits[auditIndex].completedAt = new Date().toISOString();
                
                // Generate findings based on template responses or default findings
                if (currentAuditTemplate && currentAuditResponses) {
                    currentAudits[auditIndex].findings = generateTemplateFindings();
                } else {
                    currentAudits[auditIndex].findings = generateSampleFindings();
                }
                
                // Update final score
                currentAudits[auditIndex].finalScore = currentScore;
                currentAudits[auditIndex].finalMaxScore = maxScore;
                currentAudits[auditIndex].finalPercentage = maxScore > 0 ? Math.round((currentScore / maxScore) * 100) : null;
                
                localStorage.setItem('audits', JSON.stringify(currentAudits));
            }

            document.getElementById('progressText').textContent = '¬°Auditor√≠a completada con √©xito!';
            
            setTimeout(() => {
                document.getElementById('auditProgress').classList.add('hidden');
                document.getElementById('scoringDisplay').classList.add('hidden');
                document.getElementById('auditForm').reset();
                document.getElementById('dynamicAuditForm').innerHTML = '';
                document.getElementById('templateSelect').value = '';
                currentAuditTemplate = null;
                currentAuditResponses = {};
                currentScore = 0;
                maxScore = 0;
                alert('¬°Auditor√≠a completada! Puedes ver los resultados en la pesta√±a "Resultados".');
            }, 2000);
        }

        function generateTemplateFindings() {
            const findings = [];
            
            // Analyze responses to generate findings
            currentAuditTemplate.sections.forEach((section, sectionIndex) => {
                section.questions.forEach((question, questionIndex) => {
                    const responseKey = `${sectionIndex}_${questionIndex}`;
                    const response = currentAuditResponses[responseKey];
                    
                    if (response && question.scored) {
                        const percentage = question.scoring?.maxScore ? (response.score / question.scoring.maxScore) * 100 : 0;
                        
                        let finding = {
                            section: section.name,
                            question: question.text,
                            response: response.value,
                            score: response.score,
                            maxScore: question.scoring?.maxScore || 10
                        };
                        
                        if (percentage >= 80) {
                            finding.type = 'info';
                            finding.title = 'Cumplimiento satisfactorio';
                            finding.description = `${question.text}: ${response.value}`;
                            finding.recommendation = 'Mantener las buenas pr√°cticas identificadas.';
                            finding.severity = 'Baja';
                        } else if (percentage >= 50) {
                            finding.type = 'warning';
                            finding.title = '√Årea de mejora identificada';
                            finding.description = `${question.text}: ${response.value}`;
                            finding.recommendation = 'Implementar medidas correctivas para mejorar el cumplimiento.';
                            finding.severity = 'Media';
                        } else {
                            finding.type = 'error';
                            finding.title = 'Incumplimiento cr√≠tico';
                            finding.description = `${question.text}: ${response.value}`;
                            finding.recommendation = 'Acci√≥n correctiva inmediata requerida.';
                            finding.severity = 'Alta';
                        }
                        
                        findings.push(finding);
                    }
                });
            });
            
            return findings.length > 0 ? findings : generateSampleFindings();
        }

        function generateSampleFindings() {
            const findings = [
                {
                    type: 'error',
                    title: 'Control de acceso insuficiente',
                    description: 'Se encontraron privilegios de usuario excesivos en el sistema contable.',
                    recommendation: 'Implementar principio de menor privilegio.',
                    severity: 'Alta'
                },
                {
                    type: 'warning',
                    title: 'Documentaci√≥n incompleta',
                    description: 'Faltan pol√≠ticas actualizadas para el manejo de efectivo.',
                    recommendation: 'Actualizar manual de procedimientos.',
                    severity: 'Media'
                },
                {
                    type: 'info',
                    title: 'Proceso eficiente identificado',
                    description: 'El proceso de reconciliaci√≥n bancaria es robusto.',
                    recommendation: 'Mantener el proceso actual.',
                    severity: 'Baja'
                }
            ];
            
            return findings;
        }

        function loadResults() {
            const container = document.getElementById('resultsContainer');
            
            if (currentAudits.length === 0) {
                container.innerHTML = '<p>No hay auditor√≠as completadas a√∫n.</p>';
                return;
            }

            let html = '';
            currentAudits.forEach(audit => {
                const scoreInfo = audit.finalPercentage !== null ? 
                    `<p><strong>Puntuaci√≥n:</strong> ${audit.finalScore}/${audit.finalMaxScore} (${audit.finalPercentage}%)</p>` : '';
                
                const templateInfo = audit.templateName ? 
                    `<p><strong>Plantilla utilizada:</strong> ${audit.templateName}</p>` : '';
                
                html += `
                    <div class="audit-results">
                        <h3>${audit.company} - ${audit.type}</h3>
                        <p><strong>Estado:</strong> ${audit.status}</p>
                        <p><strong>Auditor:</strong> ${audit.auditor}</p>
                        <p><strong>Per√≠odo:</strong> ${audit.startDate} al ${audit.endDate}</p>
                        <p><strong>Fecha de creaci√≥n:</strong> ${new Date(audit.createdAt).toLocaleDateString()}</p>
                        ${templateInfo}
                        ${scoreInfo}
                        
                        ${audit.findings ? renderFindings(audit.findings) : ''}
                        
                        <button class="btn btn-secondary" onclick="downloadReport(${audit.id})">
                            Descargar Reporte
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderFindings(findings) {
            let html = '<h4>Hallazgos:</h4>';
            findings.forEach(finding => {
                html += `
                    <div class="result-item ${finding.type}">
                        <h5>${finding.title}</h5>
                        <p><strong>Descripci√≥n:</strong> ${finding.description}</p>
                        <p><strong>Recomendaci√≥n:</strong> ${finding.recommendation}</p>
                        <p><strong>Severidad:</strong> ${finding.severity}</p>
                    </div>
                `;
            });
            return html;
        }

        function generateReport(type) {
            const selectedAuditId = document.getElementById('reportAuditSelect').value;
            
            if (type === 'dashboard') {
                generateDashboardReport();
                return;
            }
            
            if (!selectedAuditId) {
                alert('Por favor selecciona una auditor√≠a para generar el reporte.');
                return;
            }
            
            const audit = currentAudits.find(a => a.id === parseInt(selectedAuditId));
            if (!audit) {
                alert('Auditor√≠a no encontrada.');
                return;
            }
            
            let reportContent = '';
            
            switch (type) {
                case 'executive':
                    reportContent = generateExecutiveReport(audit);
                    break;
                case 'detailed':
                    reportContent = generateDetailedReport(audit);
                    break;
                case 'compliance':
                    reportContent = generateComplianceReport(audit);
                    break;
                default:
                    alert('Tipo de reporte no reconocido.');
                    return;
            }
            
            downloadGeneratedReport(reportContent, `${type}_${audit.company}_${audit.id}`);
        }

        function generateExecutiveReport(audit) {
            return `
REPORTE EJECUTIVO DE AUDITOR√çA
==============================

RESUMEN EJECUTIVO
-----------------
Empresa: ${audit.company}
Auditor: ${audit.auditor}
Fecha: ${new Date(audit.createdAt).toLocaleDateString()}
${audit.templateName ? `Plantilla: ${audit.templateName}` : ''}

PUNTUACI√ìN GENERAL
------------------
${audit.finalPercentage !== null ? `
Cumplimiento: ${audit.finalPercentage}%
Calificaci√≥n: ${audit.finalPercentage >= 90 ? 'EXCELENTE' :
              audit.finalPercentage >= 80 ? 'BUENO' :
              audit.finalPercentage >= 70 ? 'ACEPTABLE' :
              audit.finalPercentage >= 50 ? 'DEFICIENTE' : 'CR√çTICO'}

HALLAZGOS CR√çTICOS
------------------` : 'No se aplic√≥ sistema de puntuaci√≥n.'}

${audit.findings ? audit.findings
    .filter(f => f.severity === 'Alta')
    .map(f => `‚Ä¢ ${f.title}\n  Acci√≥n requerida: ${f.recommendation}`)
    .join('\n\n') || 'No se identificaron hallazgos cr√≠ticos.' : 'No hay hallazgos registrados.'}

RECOMENDACIONES PRIORITARIAS
----------------------------
${audit.finalPercentage >= 80 ? 
'‚Ä¢ Mantener las buenas pr√°cticas actuales\n‚Ä¢ Establecer programa de mejora continua' :
'‚Ä¢ Implementar plan de acci√≥n correctiva inmediato\n‚Ä¢ Programar auditor√≠a de seguimiento\n‚Ä¢ Capacitar personal en √°reas deficientes'}

---
Reporte ejecutivo generado por FreeAuditor
${new Date().toLocaleString()}
            `;
        }

        function generateComplianceReport(audit) {
            return `
REPORTE DE CUMPLIMIENTO
=======================

INFORMACI√ìN DE LA AUDITOR√çA
---------------------------
Empresa: ${audit.company}
Tipo: ${audit.type}
Auditor: ${audit.auditor}
Per√≠odo: ${audit.startDate} al ${audit.endDate}
${audit.templateName ? `Est√°ndar aplicado: ${audit.templateName}` : ''}

M√âTRICAS DE CUMPLIMIENTO
------------------------
${audit.finalPercentage !== null ? `
Porcentaje de Cumplimiento: ${audit.finalPercentage}%
Puntuaci√≥n: ${audit.finalScore}/${audit.finalMaxScore}

CLASIFICACI√ìN REGULATORIA:
${audit.finalPercentage >= 95 ? 'üü¢ CUMPLIMIENTO TOTAL - Sin observaciones' :
  audit.finalPercentage >= 85 ? 'üü° CUMPLIMIENTO ACEPTABLE - Observaciones menores' :
  audit.finalPercentage >= 70 ? 'üü† CUMPLIMIENTO PARCIAL - Requiere correcciones' :
  'üî¥ INCUMPLIMIENTO - Requiere acci√≥n inmediata'}

DETALLE POR SEVERIDAD
---------------------` : 'Sistema de puntuaci√≥n no aplicado.'}

${audit.findings ? `
Hallazgos Cr√≠ticos (Alta): ${audit.findings.filter(f => f.severity === 'Alta').length}
Hallazgos Importantes (Media): ${audit.findings.filter(f => f.severity === 'Media').length}
Observaciones (Baja): ${audit.findings.filter(f => f.severity === 'Baja').length}

ACCIONES CORRECTIVAS REQUERIDAS
-------------------------------
${audit.findings.filter(f => f.severity === 'Alta' || f.severity === 'Media')
    .map((f, i) => `${i + 1}. ${f.title}\n   Recomendaci√≥n: ${f.recommendation}\n   Plazo: ${f.severity === 'Alta' ? 'Inmediato (7 d√≠as)' : 'Corto plazo (30 d√≠as)'}`)
    .join('\n\n') || 'No se requieren acciones correctivas cr√≠ticas.'}` : 'No hay hallazgos para evaluar cumplimiento.'}

CERTIFICACI√ìN DE CUMPLIMIENTO
-----------------------------
${audit.finalPercentage >= 85 ? 
'‚úÖ La organizaci√≥n CUMPLE con los est√°ndares evaluados.' :
'‚ùå La organizaci√≥n NO CUMPLE completamente con los est√°ndares evaluados.'}

Auditor Certificador: ${audit.auditor}
Fecha de Certificaci√≥n: ${new Date().toLocaleDateString()}

---
Reporte de cumplimiento generado por FreeAuditor
Certificado digital: ${Math.random().toString(36).substr(2, 9).toUpperCase()}
            `;
        }

        function generateDashboardReport() {
            const completedAudits = currentAudits.filter(a => a.status === 'Completada');
            const totalScore = completedAudits.reduce((sum, audit) => sum + (audit.finalPercentage || 0), 0);
            const averageScore = completedAudits.length > 0 ? Math.round(totalScore / completedAudits.length) : 0;
            const templatesUsedCount = new Set(currentAudits.filter(a => a.templateId).map(a => a.templateId)).size;
            
            // Update dashboard stats
            document.getElementById('totalAudits').textContent = currentAudits.length;
            document.getElementById('completedAudits').textContent = completedAudits.length;
            document.getElementById('averageScore').textContent = averageScore + '%';
            document.getElementById('templatesUsed').textContent = templatesUsedCount;
            
            document.getElementById('reportsSummary').classList.remove('hidden');
            
            // Generate downloadable dashboard report
            const dashboardContent = `
DASHBOARD DE AUDITOR√çAS - RESUMEN EJECUTIVO
==========================================

ESTAD√çSTICAS GENERALES
----------------------
Total de Auditor√≠as: ${currentAudits.length}
Auditor√≠as Completadas: ${completedAudits.length}
Auditor√≠as en Progreso: ${currentAudits.filter(a => a.status === 'En Progreso').length}
Puntuaci√≥n Promedio: ${averageScore}%
Plantillas Utilizadas: ${templatesUsedCount}

DETALLE POR AUDITOR√çA
--------------------
${currentAudits.map(audit => `
‚Ä¢ ${audit.company} (${audit.type})
  Estado: ${audit.status}
  Auditor: ${audit.auditor}
  ${audit.finalPercentage !== null ? `Cumplimiento: ${audit.finalPercentage}%` : 'Sin puntuaci√≥n'}
  ${audit.templateName ? `Plantilla: ${audit.templateName}` : 'Sin plantilla'}
`).join('')}

AN√ÅLISIS DE TENDENCIAS
---------------------
${completedAudits.length > 0 ? `
Mejor Rendimiento: ${Math.max(...completedAudits.map(a => a.finalPercentage || 0))}%
Menor Rendimiento: ${Math.min(...completedAudits.map(a => a.finalPercentage || 0))}%
Desviaci√≥n Est√°ndar: ${calculateStandardDeviation(completedAudits.map(a => a.finalPercentage || 0)).toFixed(1)}%

RECOMENDACIONES DEL SISTEMA
---------------------------
${averageScore >= 85 ? 
'‚Ä¢ Excelente desempe√±o general del sistema de auditor√≠as\n‚Ä¢ Continuar con las pr√°cticas actuales\n‚Ä¢ Considerar auditor√≠as de mantenimiento' :
averageScore >= 70 ?
'‚Ä¢ Desempe√±o aceptable con oportunidades de mejora\n‚Ä¢ Revisar auditor√≠as con menor puntuaci√≥n\n‚Ä¢ Implementar planes de acci√≥n espec√≠ficos' :
'‚Ä¢ Desempe√±o por debajo del est√°ndar\n‚Ä¢ Revisar procesos de auditor√≠a\n‚Ä¢ Capacitaci√≥n adicional requerida\n‚Ä¢ Seguimiento intensivo necesario'}` : 'Insuficientes datos para an√°lisis de tendencias.'}

---
Dashboard generado por FreeAuditor el ${new Date().toLocaleString()}
            `;
            
            downloadGeneratedReport(dashboardContent, 'dashboard_general');
        }

        function calculateStandardDeviation(values) {
            if (values.length === 0) return 0;
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
            const avgSquaredDiff = squaredDiffs.reduce((sum, val) => sum + val, 0) / values.length;
            return Math.sqrt(avgSquaredDiff);
        }

        function downloadGeneratedReport(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function loadReportAudits() {
            const select = document.getElementById('reportAuditSelect');
            select.innerHTML = '<option value="">Seleccionar auditor√≠a...</option>';
            
            currentAudits.forEach(audit => {
                const option = document.createElement('option');
                option.value = audit.id;
                option.textContent = `${audit.company} - ${audit.type} (${audit.status})`;
                select.appendChild(option);
            });
        }

        function downloadReport(auditId) {
            const audit = currentAudits.find(a => a.id === auditId);
            if (!audit) return;

            const reportContent = generateDetailedReport(audit);

            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_auditoria_${audit.company}_${audit.id}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function generateDetailedReport(audit) {
            let reportContent = `
REPORTE DE AUDITOR√çA DETALLADO
=================================

INFORMACI√ìN GENERAL
-------------------
Empresa: ${audit.company}
Tipo de Auditor√≠a: ${audit.type}
Auditor: ${audit.auditor}
Per√≠odo: ${audit.startDate} al ${audit.endDate}
Estado: ${audit.status}
Fecha de Creaci√≥n: ${new Date(audit.createdAt).toLocaleDateString()}
${audit.completedAt ? `Fecha de Finalizaci√≥n: ${new Date(audit.completedAt).toLocaleDateString()}` : ''}

${audit.templateName ? `
PLANTILLA UTILIZADA
-------------------
Nombre: ${audit.templateName}
` : ''}

${audit.finalPercentage !== null ? `
RESUMEN DE PUNTUACI√ìN
---------------------
Puntuaci√≥n Obtenida: ${audit.finalScore || 0}
Puntuaci√≥n M√°xima: ${audit.finalMaxScore || 0}
Porcentaje de Cumplimiento: ${audit.finalPercentage || 0}%

CLASIFICACI√ìN DEL CUMPLIMIENTO:
${audit.finalPercentage >= 90 ? 'üü¢ EXCELENTE - Cumplimiento excepcional' :
  audit.finalPercentage >= 80 ? 'üü° BUENO - Cumplimiento satisfactorio' :
  audit.finalPercentage >= 70 ? 'üü† ACEPTABLE - Requiere algunas mejoras' :
  audit.finalPercentage >= 50 ? 'üî¥ DEFICIENTE - Requiere mejoras significativas' :
  'üö® CR√çTICO - Requiere acci√≥n inmediata'}
` : ''}

HALLAZGOS DETALLADOS
--------------------`;

            if (audit.findings && audit.findings.length > 0) {
                audit.findings.forEach((finding, index) => {
                    const severityIcon = finding.severity === 'Alta' ? 'üö®' : 
                                       finding.severity === 'Media' ? '‚ö†Ô∏è' : '‚úÖ';
                    
                    reportContent += `

${index + 1}. ${finding.title} ${severityIcon}
   Severidad: ${finding.severity}
   ${finding.section ? `Secci√≥n: ${finding.section}` : ''}
   
   Descripci√≥n: ${finding.description}
   
   Recomendaci√≥n: ${finding.recommendation}
   
   ${finding.score !== undefined ? `Puntuaci√≥n: ${finding.score}/${finding.maxScore || 10}` : ''}
   `;
                });
            } else {
                reportContent += '\nNo se registraron hallazgos espec√≠ficos.';
            }

            reportContent += `

RESPUESTAS DETALLADAS
---------------------`;

            if (audit.responses && Object.keys(audit.responses).length > 0) {
                Object.entries(audit.responses).forEach(([question, answer]) => {
                    reportContent += `\n${question}: ${Array.isArray(answer) ? answer.join(', ') : answer}`;
                });
            } else {
                reportContent += '\nNo hay respuestas detalladas registradas.';
            }

            reportContent += `

RECOMENDACIONES GENERALES
-------------------------
${audit.finalPercentage >= 80 ? 
`‚Ä¢ Mantener las buenas pr√°cticas identificadas
‚Ä¢ Continuar con el programa de auditor√≠as regulares
‚Ä¢ Documentar las mejores pr√°cticas para futuras referencias` :
`‚Ä¢ Implementar un plan de acci√≥n correctiva
‚Ä¢ Programar seguimiento en 30-60 d√≠as
‚Ä¢ Capacitar al personal en las √°reas identificadas
‚Ä¢ Revisar y actualizar procedimientos seg√∫n sea necesario`}

---
Reporte generado autom√°ticamente por FreeAuditor
Fecha de generaci√≥n: ${new Date().toLocaleString()}
Versi√≥n del sistema: 2.0
            `;

            return reportContent;
        }

        function saveSettings() {
            const settings = {
                language: document.getElementById('language').value,
                defaultAuditor: document.getElementById('defaultAuditor').value,
                companyInfo: document.getElementById('companyInfo').value
            };
            
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('Configuraci√≥n guardada exitosamente.');
        }

        // Cargar configuraci√≥n al iniciar
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('settings') || '{}');
            
            if (settings.language) {
                document.getElementById('language').value = settings.language;
            }
            if (settings.defaultAuditor) {
                document.getElementById('defaultAuditor').value = settings.defaultAuditor;
                document.getElementById('auditor').value = settings.defaultAuditor;
            }
            if (settings.companyInfo) {
                document.getElementById('companyInfo').value = settings.companyInfo;
            }
        }

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadResults();
            loadTemplates();
            loadTemplateSelector();
        });
    </script>
</body>
</html>